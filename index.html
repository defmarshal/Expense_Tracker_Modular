<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FinTrack - Smart Expense Tracking</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- <script src="./js/config.js"></script> -->
    
    <!-- Modular CSS Files - IMPORTANT: Order matters! -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/pages/landing.css">
    <link rel="stylesheet" href="css/pages/dashboard.css">
    <link rel="stylesheet" href="css/utilities.css">
    <link rel="stylesheet" href="css/fab.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/reimbursement.css">
    <link rel="stylesheet" href="css/receipt.css">
    <link rel="stylesheet" href="css/settings.css">
</head>

<body>
    <header>
        <div class="logo">
            <i class="fas fa-chart-pie"></i>
            <span>FinTrack</span>
        </div>
        
        <div class="nav-links" id="navLinks">
            <a href="index.html" class="nav-link active">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="analytics.html" class="nav-link">
                <i class="fas fa-chart-bar"></i>
                <span>Analytics</span>
            </a>
        </div>
        
        <div class="auth-section">
            <button id="loginBtn" class="btn btn-outline">
                <i class="fas fa-sign-in-alt"></i>
                <span>Sign In</span>
            </button>
            <button id="signupBtn" class="btn btn-primary">
                <i class="fas fa-user-plus"></i>
                <span>Join</span>
            </button>
            <button id="logoutBtn" class="btn btn-outline hidden">
                <i class="fas fa-sign-out-alt"></i>
                <span>Sign Out</span>
            </button>
        </div>
    </header>

    <div id="landingPage" class="landing-page">
        <section class="hero">
            <div class="hero-content">
                <h1>Track Expenses.<br>Master Your Finances.</h1>
                <p>FinTrack helps you understand where your money goes with beautiful visuals and powerful insights.</p>
                <div class="hero-buttons">
                    <button id="heroSignupBtn" class="btn btn-primary">
                        <i class="fas fa-rocket"></i>
                        Start Free Trial
                    </button>
                    <button class="btn btn-outline">
                        <i class="fas fa-play-circle"></i>
                        Watch Demo
                    </button>
                </div>
                <div class="hero-image">
                    <div style="background: var(--gradient); height: 320px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.3rem;">
                        FinTrack Dashboard Preview
                    </div>
                </div>
            </div>
        </section>

        <section class="features">
            <div class="section-header">
                <h2 class="section-title">Everything You Need</h2>
                <p class="section-subtitle">Manage your finances with ease</p>
            </div>
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <h3 class="feature-title">Multiple Wallets</h3>
                    <p class="feature-description">Track expenses across multiple wallets and bank accounts.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-tags"></i>
                    </div>
                    <h3 class="feature-title">Smart Categories</h3>
                    <p class="feature-description">Organize expenses with custom categories.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h3 class="feature-title">Visual Reports</h3>
                    <p class="feature-description">Understand spending patterns instantly.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <h3 class="feature-title">Income Tracking</h3>
                    <p class="feature-description">Track all your income sources.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h3 class="feature-title">Secure & Private</h3>
                    <p class="feature-description">Enterprise-grade security for your data.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-sync"></i>
                    </div>
                    <h3 class="feature-title">Real-time Sync</h3>
                    <p class="feature-description">Stay updated across all devices.</p>
                </div>
            </div>
        </section>

        <section class="cta">
            <h2>Ready to take control?</h2>
            <p>Join thousands of users who've transformed their finances with FinTrack.</p>
            <div class="cta-buttons">
                <button id="ctaSignupBtn" class="btn btn-white">
                    <i class="fas fa-rocket"></i>
                    Get Started Free
                </button>
            </div>
        </section>

        <footer>
            <div class="footer-content">
                <div class="footer-column">
                    <h3>FinTrack</h3>
                    <ul class="footer-links">
                        <li><a href="#">About Us</a></li>
                        <li><a href="#">Blog</a></li>
                        <li><a href="#">Press</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Product</h3>
                    <ul class="footer-links">
                        <li><a href="#">Features</a></li>
                        <li><a href="#">Security</a></li>
                        <li><a href="#">Roadmap</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Resources</h3>
                    <ul class="footer-links">
                        <li><a href="#">Help Center</a></li>
                        <li><a href="#">Community</a></li>
                        <li><a href="#">Guides</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Legal</h3>
                    <ul class="footer-links">
                        <li><a href="#">Privacy</a></li>
                        <li><a href="#">Terms</a></li>
                        <li><a href="#">GDPR</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 FinTrack. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <div id="dashboardContainer" class="dashboard-container">
        
        <!-- Desktop Sidebar Navigation -->
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <a href="#" class="sidebar-nav-item active" data-tab="overview">
                    <i class="fas fa-home"></i>
                    <span>Overview</span>
                </a>
                <a href="#" class="sidebar-nav-item" data-tab="expenses">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Expenses</span>
                </a>
                <a href="#" class="sidebar-nav-item" data-tab="income">
                    <i class="fas fa-coins"></i>
                    <span>Income</span>
                </a>
                <a href="#" class="sidebar-nav-item" data-tab="budget">
                    <i class="fas fa-chart-line"></i>
                    <span>Budget</span>
                </a>
                <a href="#" class="sidebar-nav-item" data-tab="more">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>
        </aside>
        
        <!-- Main Content Area (with sidebar offset) -->
        <div class="dashboard-with-sidebar">
            <div class="container">    
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Dashboard</h1>
                    <div class="wallet-selector-container">
                        <label for="globalWalletSelect">Wallet:</label>
                        <select id="globalWalletSelect">
                            <option value="">Select wallet</option>
                        </select>
                        <span id="userEmail"></span>
                    </div>
                </div>

                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-label">Income</div>
                        <div class="stat-value income" id="totalIncome">Rp 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Expenses</div>
                        <div class="stat-value expense" id="totalExpenses">Rp 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Balance</div>
                        <div class="stat-value balance" id="currentWalletBalance">Rp 0</div>
                    </div>
                    <!-- <div class="stat-card reimbursement">
                        <div class="stat-label">
                            <i class="fas fa-clock"></i> Pending Reimbursement
                        </div>
                        <div class="stat-value" id="pendingReimbursementTotal">Rp 0</div>
                    </div>                     -->
                </div>

                <div id="overviewTab" class="tab-content active">
                    <!-- Compact Budget Overview -->
                    <div class="budget-overview-compact">
                        <h2 class="form-title">Budget Status</h2>
                        <div id="budgetOverviewList">
                            <div class="budget-overview-item">
                                <div class="budget-details">No budgets set</div>
                            </div>
                        </div>
                    </div>

                    <!-- Expandable Recent Activity -->
                    <div class="expense-list">
                        <h2 class="form-title" style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;" onclick="toggleRecentActivity()">
                            <span>Recent Activity</span>
                            <i class="fas fa-chevron-down" id="recentActivityChevron" style="transition: transform 0.3s ease;"></i>
                        </h2>
                        <div id="recentActivityContainer" style="display: none; transition: all 0.3s ease;">
                            <div id="recentActivityList">
                                <div class="expense-item">
                                    <div class="expense-details">No transactions yet</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="budgetTab" class="tab-content">
                    <div class="budget-management">
                        <!-- Removed the top "Set Budget" button -->
                        <h2 class="form-title" style="margin-bottom: 1.5rem;">Category Budgets</h2>
                        
                        <div id="budgetCategoriesList">
                            <div class="budget-item">
                                <div class="budget-details">Loading categories...</div>
                            </div>
                        </div>
                    </div>
                </div>               

                <!-- Expenses Tab -->
                <div id="expensesTab" class="tab-content">
                    <!-- Sub-navigation tabs -->
                    <div class="expense-sub-tabs">
                        <button class="expense-sub-tab active" data-subtab="all">
                            <i class="fas fa-list"></i>
                            All Expenses
                        </button>
                        <button class="expense-sub-tab" data-subtab="reimbursement">
                            <i class="fas fa-exchange-alt"></i>
                            Reimbursements
                        </button>
                    </div>

                    <!-- All Expenses View (existing content) -->
                    <div id="allExpensesView" class="expense-sub-view">
                        <div class="month-filter">
                            <label for="expenseMonthSelect">Month:</label>
                            <select id="expenseMonthSelect"></select>
                            <label for="expenseYearSelect">Year:</label>
                            <select id="expenseYearSelect"></select>
                        </div>
                        
                        <div class="expense-summary">
                            <h3>Total for <span id="expenseSelectedMonthYear">this month</span></h3>
                            <div class="expense-summary-amount" id="expenseMonthlyTotal">Rp 0</div>
                        </div>
                        
                        <div class="expense-list">
                            <div id="expensesByDayList">
                                <div class="expense-item">
                                    <div class="expense-details">Select a month</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reimbursement View (new) -->
                    <div id="reimbursementView" class="expense-sub-view" style="display: none;">
                        <!-- Reimbursement Dashboard Stats -->
                        <div class="reimbursement-dashboard">
                            <div class="reimbursement-stat-card pending">
                                <div class="reimbursement-stat-label">
                                    <i class="fas fa-clock"></i>
                                    <!-- Pending Reimbursement -->
                                    Pending
                                </div>
                                <div class="reimbursement-stat-value" id="reimbPendingTotal">Rp 0</div>
                                <div class="reimbursement-stat-count" id="reimbPendingCount">0 expenses</div>
                            </div>
                            
                            <div class="reimbursement-stat-card reimbursed">
                                <div class="reimbursement-stat-label">
                                    <i class="fas fa-check-circle"></i>
                                    Reimbursed
                                </div>
                                <div class="reimbursement-stat-value" id="reimbReimbursedTotal">Rp 0</div>
                                <div class="reimbursement-stat-count" id="reimbReimbursedCount">0 expenses</div>
                            </div>
                        </div>

                        <!-- Pending Reimbursable Expenses -->
                        <div class="reimbursement-section">
                            <div class="reimbursement-section-header">
                                <div class="reimbursement-section-title pending">
                                    <i class="fas fa-clock"></i>
                                    <span>Pending Reimbursement</span>
                                </div>
                                <span class="reimbursement-section-count" id="pendingReimbursementCount">0</span>
                            </div>
                            <div id="pendingReimbursementList">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Reimbursed Expenses & Linked Income -->
                        <div class="reimbursement-section">
                            <div class="reimbursement-section-header">
                                <div class="reimbursement-section-title reimbursed">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Reimbursed</span>
                                </div>
                                <span class="reimbursement-section-count" id="reimbursedCount">0</span>
                            </div>
                            <div id="reimbursedList">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Income Tab -->
                <div id="incomeTab" class="tab-content">
                    <div class="month-filter">
                        <label for="incomeMonthSelect">Month:</label>
                        <select id="incomeMonthSelect"></select>
                        <label for="incomeYearSelect">Year:</label>
                        <select id="incomeYearSelect"></select>
                    </div>
                    
                    <div class="expense-summary">
                        <h3>Total for <span id="incomeSelectedMonthYear">this month</span></h3>
                        <div class="expense-summary-amount" style="color: var(--success);" id="incomeMonthlyTotal">Rp 0</div>
                    </div>
                    
                    <div class="income-list">
                        <div id="incomesByDayList">
                            <div class="income-item">
                                <div class="income-details">Select a month</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- REPLACE THIS ENTIRE SECTION -->
                <div id="moreTab" class="tab-content">
                    <!-- Data Management Section -->
                    <div class="settings-section">
                        <h2 class="settings-section-title">
                            <i class="fas fa-database"></i>
                            Data Management
                        </h2>
                        
                        <div class="settings-card" onclick="window.finTrack.ui.openExportModal()" style="cursor: pointer;">
                            <div class="settings-card-icon">
                                <i class="fas fa-download"></i>
                            </div>
                            <div class="settings-card-content">
                                <div class="settings-card-title">Export Data</div>
                                <div class="settings-card-description">Download transactions, budgets, and reports</div>
                            </div>
                            <div class="settings-card-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Account Setup Section -->
                    <div class="settings-section">
                        <h2 class="settings-section-title">
                            <i class="fas fa-wallet"></i>
                            Account Setup
                        </h2>
                        
                        <!-- Wallets Card -->
                        <div class="settings-card expandable">
                            <div class="settings-card-header" onclick="toggleSettingsSection('wallets')">
                                <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                    <div class="settings-card-icon">
                                        <i class="fas fa-wallet"></i>
                                    </div>
                                    <div class="settings-card-content">
                                        <div class="settings-card-title">My Wallets</div>
                                        <div class="settings-card-description" id="walletsCount">Loading...</div>
                                    </div>
                                </div>
                                <div class="settings-card-arrow">
                                    <i class="fas fa-chevron-down" id="walletsChevron"></i>
                                </div>
                            </div>
                            <div class="settings-card-body" id="walletsBody" style="display: none;">
                                <div id="walletsList">
                                    <div class="wallet-item">
                                        <div class="wallet-details">No wallets yet</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Categories Card -->
                        <div class="settings-card expandable">
                            <div class="settings-card-header" onclick="toggleSettingsSection('categories')">
                                <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                    <div class="settings-card-icon">
                                        <i class="fas fa-tags"></i>
                                    </div>
                                    <div class="settings-card-content">
                                        <div class="settings-card-title">Categories</div>
                                        <div class="settings-card-description" id="categoriesCount">Loading...</div>
                                    </div>
                                </div>
                                <div class="settings-card-arrow">
                                    <i class="fas fa-chevron-down" id="categoriesChevron"></i>
                                </div>
                            </div>
                            <div class="settings-card-body" id="categoriesBody" style="display: none;">
                                <div id="categoriesList">
                                    <div class="category-item">
                                        <div class="category-details">No categories yet</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Section (Future) -->
                    <div class="settings-section">
                        <h2 class="settings-section-title">
                            <i class="fas fa-user"></i>
                            Profile
                        </h2>
                        
                        <div class="settings-card">
                            <div class="settings-card-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div class="settings-card-content">
                                <div class="settings-card-title">Email</div>
                                <div class="settings-card-description" id="userEmailSettings">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Mobile Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="bottom-nav-items">
                <a href="#" class="bottom-nav-item active" data-tab="overview">
                    <i class="fas fa-home"></i>
                    <span>Overview</span>
                </a>
                <a href="#" class="bottom-nav-item" data-tab="expenses">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Expenses</span>
                </a>
                <a href="#" class="bottom-nav-item" data-tab="income">
                    <i class="fas fa-coins"></i>
                    <span>Income</span>
                </a>
                <a href="#" class="bottom-nav-item" data-tab="budget">
                    <i class="fas fa-chart-line"></i>
                    <span>Budget</span>
                </a>
                <a href="#" class="bottom-nav-item" data-tab="more">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </div>
        </nav>
        
    </div>

    <div class="modal-overlay" id="subcategoryModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" id="closeSubcategoryModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Add Subcategory</h2>
                <p class="modal-subtitle">Quick add</p>
            </div>
            <div class="modal-body">
                <form id="subcategoryForm">
                    <div class="form-group">
                        <label for="subcategoryName">Name</label>
                        <input type="text" id="subcategoryName" placeholder="e.g., Groceries" required>
                    </div>
                    <input type="hidden" id="parentCategoryId">
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header" style="background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);">
                <button class="modal-close" id="closeDeleteModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Delete?</h2>
                <p class="modal-subtitle">This can't be undone</p>
            </div>
            <div class="modal-body">
                <p id="deleteMessage" style="margin-bottom: 1.5rem; font-size: 0.95rem;"></p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline" id="cancelDeleteBtn" style="flex: 1;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="btn" id="confirmDeleteBtn" style="flex: 1; background: #EF4444; color: white;">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay insufficient-balance-modal" id="insufficientBalanceModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" id="closeInsufficientBalanceModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Not Enough Balance</h2>
                <p class="modal-subtitle">Need more funds</p>
            </div>
            <div class="modal-body">
                <div class="balance-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <h3 style="font-size: 0.95rem; margin-bottom: 0.3rem;">Insufficient funds</h3>
                        <p style="font-size: 0.85rem; opacity: 0.9;">Add income to proceed</p>
                    </div>
                </div>
                <div class="balance-details">
                    <div class="balance-item">
                        <span>Expense:</span>
                        <strong id="expenseAmountDetail">Rp 0</strong>
                    </div>
                    <div class="balance-item">
                        <span>Balance:</span>
                        <strong id="walletBalanceDetail">Rp 0</strong>
                    </div>
                    <div class="balance-item">
                        <span>After:</span>
                        <strong id="remainingBalanceDetail" style="color: var(--danger);">Rp 0</strong>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" id="addFundsBtn" style="flex: 1;">
                        <i class="fas fa-plus"></i> Add Income
                    </button>
                    <button class="btn btn-outline" id="cancelExpenseBtn" style="flex: 1;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="signupModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" id="closeSignupModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Join FinTrack</h2>
                <p class="modal-subtitle">Start tracking today</p>
            </div>
            <div class="modal-body">
                <form id="signupForm">
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" placeholder="your@email.com" required>
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" placeholder="Create password" required>
                        <div class="password-strength">
                            <div class="strength-bar" id="passwordStrength"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm</label>
                        <input type="password" id="confirmPassword" placeholder="Confirm password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">
                        <i class="fas fa-user-plus"></i> Create Account
                    </button>
                </form>
                <div style="text-align: center; margin-top: 1.2rem;">
                    <p style="font-size: 0.9rem;">Already have an account? <a href="#" id="showLoginFromSignup" style="color: var(--primary); text-decoration: none; font-weight: 600;">Sign in</a></p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="loginModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" id="closeLoginModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Welcome Back</h2>
                <p class="modal-subtitle">Sign in to continue</p>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="your@email.com" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">
                        <i class="fas fa-sign-in-alt"></i> Sign In
                    </button>
                </form>
                <div style="text-align: center; margin-top: 1.2rem;">
                    <p style="font-size: 0.9rem;">Don't have an account? <a href="#" id="showSignupFromLogin" style="color: var(--primary); text-decoration: none; font-weight: 600;">Join now</a></p>
                </div>
            </div>
        </div>
    </div>

    <div id="alertContainer" style="position: fixed; top: 80px; right: 12px; z-index: 3000; max-width: 350px;"></div>

    <div id="editTransactionModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header" style="background: linear-gradient(135deg, #9333EA 0%, #C084FC 100%); position: relative; overflow: hidden;">
                <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%; animation: float 3s ease-in-out infinite;"></div>
                <button class="modal-close" onclick="document.getElementById('editTransactionModal').classList.remove('active')">
                    <i class="fas fa-times"></i>
                </button>
                <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 8px;">
                    <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <i class="fas fa-edit" style="font-size: 1.3rem; color: white;"></i>
                    </div>
                    <h2 class="modal-title" id="editModalTitle" style="margin: 0; color: white;">Edit Transaction</h2>
                </div>
                <p class="modal-subtitle" id="editModalSubtitle">Make changes and save</p>
            </div>

            <style>
            @keyframes float {
                0%, 100% { transform: translateY(0px) rotate(0deg); }
                50% { transform: translateY(-20px) rotate(180deg); }
            }
            </style>
            <div class="modal-body" style="padding: 1.25rem;">
            <form id="editTransactionForm" class="compact-form">
                <input type="hidden" id="editItemId">
                <input type="hidden" id="editItemType">
                
                <div class="form-group" style="margin-bottom: 0.8rem;">
                    <label for="editDescription" style="font-size: 0.85rem; margin-bottom: 0.3rem;">Description</label>
                    <input type="text" id="editDescription" placeholder="What was this for?" style="padding: 10px 12px; font-size: 0.95rem;">
                </div>
                
                <!-- Category and Subcategory row (for expenses only) -->
                <div class="form-row" id="editExpenseCategoryRow" style="gap: 0.8rem; margin-bottom: 0.8rem;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="editCategory" style="font-size: 0.85rem; margin-bottom: 0.3rem;">Category</label>
                        <select id="editCategory" required style="padding: 10px 12px; font-size: 0.95rem;">
                            <option value="">Select category</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="editSubcategory" style="font-size: 0.85rem; margin-bottom: 0.3rem;">Subcategory</label>
                        <select id="editSubcategory" style="padding: 10px 12px; font-size: 0.95rem;">
                            <option value="">Optional</option>
                        </select>
                    </div>
                </div>

                <!-- NEW: Income Reimbursement Section (appears after description for income) -->
                <div id="editIncomeReimbursementSection" style="display: none; margin-bottom: 1rem;">
                    <div class="reimbursement-toggle">
                        <label>
                            <input type="checkbox" id="editIncomeIsReimbursement">
                            <span>ðŸ”— This is a reimbursement</span>
                        </label>
                        <div class="toggle-hint">
                            Check this if you're being reimbursed for expenses you've already paid
                        </div>
                    </div>
                    
                    <div id="editIncomeExpenseSelector" class="hidden" style="margin-top: 1rem;">
                        <button type="button" class="btn btn-secondary" id="editSelectExpensesBtn" style="width: 100%;">
                            <i class="fas fa-list"></i>
                            <span id="editSelectedExpensesText">Select Expenses to Reimburse</span>
                        </button>
                    </div>
                </div>

                <div class="form-row" style="gap: 0.8rem; margin-bottom: 0.8rem;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="editAmount" style="font-size: 0.85rem; margin-bottom: 0.3rem;">Amount</label>
                        <div class="currency-input">
                            <span class="currency-symbol">Rp</span>
                            <input type="text" id="editAmount" placeholder="0" style="padding: 10px 12px 10px 38px; font-size: 0.95rem;">
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="editDate" style="font-size: 0.85rem; margin-bottom: 0.3rem;">Date</label>
                        <input type="date" id="editDate" required style="padding: 10px 12px; font-size: 0.95rem;">
                    </div>
                </div>

                <div class="form-group" id="editExpenseReceiptSection" style="margin-bottom: 1rem; display: none;">
                    <label for="editReceiptUpload" style="font-size: 0.85rem; margin-bottom: 0.3rem;">Receipt (optional)</label>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <input type="file" 
                            id="editReceiptUpload" 
                            accept="image/*,.pdf" 
                            style="padding: 10px 12px; font-size: 0.95rem; border: 2px dashed var(--light-gray); border-radius: 8px; cursor: pointer;">
                        <div id="editReceiptPreview" style="display: none;">
                            <!-- Receipt preview will be inserted here -->
                        </div>
                    </div>
                </div>                

                <!-- Expense Reimbursable Checkbox (MOVED HERE - after amount and date) -->
                <div class="form-group" id="editExpenseReimbursableSection" style="margin-bottom: 1rem; display: none;">
                    <label class="checkbox-label">
                        <input type="checkbox" id="editIsReimbursable">
                        <span>ðŸ’° This expense will be reimbursed</span>
                    </label>
                </div>

                <!-- Category/Type field (shows as "Type" for income) -->
                <div class="form-group" id="editIncomeTypeGroup" style="margin-bottom: 1rem; display: none;">
                    <label for="editIncomeType" style="font-size: 0.85rem; margin-bottom: 0.3rem;">Type</label>
                    <select id="editIncomeType" style="padding: 10px 12px; font-size: 0.95rem;">
                        <option value="">Select type</option>
                    </select>
                </div>

                    <div class="form-row" style="gap: 0.8rem; margin-top: 1rem;">
                        <button type="button" class="btn btn-outline" onclick="document.getElementById('editTransactionModal').classList.remove('active')" style="padding: 10px; font-size: 0.9rem; flex: 1;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" style="padding: 10px; font-size: 0.9rem; flex: 1;">
                            <i class="fas fa-save"></i> Save
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div> 

   <!-- FAB Backdrop -->
    <div class="fab-backdrop" id="fabBackdrop"></div>

    <!-- Floating Action Button -->
    <div class="fab-container" id="fabContainer">
        <div class="fab-menu" id="fabMenu">
            <button class="fab-menu-item expense" data-action="expense">
                <i class="fas fa-shopping-cart"></i>
                <span>Add Expense</span>
            </button>
            <button class="fab-menu-item income" data-action="income">
                <i class="fas fa-coins"></i>
                <span>Add Income</span>
            </button>
            <button class="fab-menu-item wallet" data-action="wallet">
                <i class="fas fa-wallet"></i>
                <span>Add Wallet</span>
            </button>
            <button class="fab-menu-item category" data-action="category">
                <i class="fas fa-tags"></i>
                <span>Add Category</span>
            </button>
            <button class="fab-menu-item budget" data-action="budget">
                <i class="fas fa-chart-line"></i>
                <span>Set Budget</span>
            </button>            
        </div>
        <button class="fab-button" id="fabButton">
            <i class="fas fa-plus"></i>
        </button>
    </div>    

<!-- Add this modal AFTER the FAB container in your index.html -->

<!-- FAB Quick Add Modal -->
    <div class="modal-overlay" id="fabQuickAddModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" id="closeFabQuickAddModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title" id="fabModalTitle">Quick Add</h2>
                <p class="modal-subtitle" id="fabModalSubtitle" style="display:none">Add new item</p>
            </div>
            <div class="modal-body">
                <!-- Expense Form -->
                <form id="fabExpenseForm" class="fab-form" style="display: none;">
                    <div class="form-group" style="margin-bottom:0.8rem;">
                        <label for="fabExpenseDescription">What did you spend on?</label>
                        <input type="text" id="fabExpenseDescription" placeholder="e.g., Lunch, Gas" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="margin-bottom:0.8rem;">
                            <label for="fabExpenseAmount">Amount</label>
                            <div class="currency-input">
                                <span class="currency-symbol">Rp</span>
                                <input type="text" id="fabExpenseAmount" placeholder="0" required>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom:0.8rem;">
                            <label for="fabExpenseDate">Date</label>
                            <input type="date" id="fabExpenseDate" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fabExpenseCategory">Category</label>
                            <select id="fabExpenseCategory" required>
                                <option value="">Select category</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fabExpenseSubcategory">Subcategory</label>
                            <select id="fabExpenseSubcategory">
                                <option value="">Optional</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="fabReceiptUpload">Receipt (optional)</label>
                        <input type="file" 
                            id="fabReceiptUpload" 
                            accept="image/*,.pdf" 
                            style="padding: 10px 12px; font-size: 0.95rem; border: 2px dashed var(--light-gray); border-radius: 8px; cursor: pointer;">
                        <div class="form-hint" style="font-size: 0.75rem; color: var(--gray); margin-top: 4px;">
                            <i class="fas fa-info-circle"></i> Upload a photo of your receipt
                        </div>
                    </div>                    
                    <!-- v5.2 -->
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="fabExpenseIsReimbursable">
                            <span>ðŸ’° This expense will be reimbursed</span>
                        </label>
                    </div>                    
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">
                        <i class="fas fa-plus"></i> Add Expense
                    </button>
                </form>

                <!-- Income Form -->
                <form id="fabIncomeForm" class="fab-form" style="display: none;">
                    <div class="form-group">
                        <label for="fabIncomeDescription">Source</label>
                        <input type="text" id="fabIncomeDescription" placeholder="e.g., Salary, Freelance" required>
                    </div>
                    
                    <!-- NEW: Reimbursement Toggle -->
                    <div class="reimbursement-toggle">
                        <label>
                            <input type="checkbox" id="fabIncomeIsReimbursement">
                            <span>ðŸ”— This is a reimbursement</span>
                        </label>
                        <div class="toggle-hint">
                            Check this if you're being reimbursed for expenses you've already paid
                        </div>
                    </div>
                    
                    <!-- Expense selector section (shown when reimbursement is checked) -->
                    <div id="fabIncomeExpenseSelector" class="hidden" style="margin-bottom: 1rem;">
                        <button type="button" class="btn btn-outline" id="fabSelectExpensesBtn" style="width: 100%;">
                            <i class="fas fa-list-check"></i>
                            <span id="fabSelectedExpensesText">Select Expenses to Reimburse</span>
                        </button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fabIncomeAmount">Amount</label>
                            <div class="currency-input">
                                <span class="currency-symbol">Rp</span>
                                <input type="text" id="fabIncomeAmount" placeholder="0" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="fabIncomeDate">Date</label>
                            <input type="date" id="fabIncomeDate" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="fabIncomeSource">Type</label>
                        <select id="fabIncomeSource" required>
                            <option value="">Select type</option>
                            <option value="Salary">Salary</option>
                            <option value="Freelance">Freelance</option>
                            <option value="Investment">Investment</option>
                            <option value="Gift">Gift</option>
                            <option value="Bonus">Bonus</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success" style="width: 100%; padding: 12px;">
                        <i class="fas fa-plus"></i> Add Income
                    </button>
                </form>

                <!-- Wallet Form -->
                <form id="fabWalletForm" class="fab-form" style="display: none;">
                    <div class="form-group">
                        <label for="fabWalletName">Wallet Name</label>
                        <input type="text" id="fabWalletName" placeholder="e.g., Cash, Bank Account" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">
                        <i class="fas fa-plus"></i> Add Wallet
                    </button>
                </form>

                <!-- Category Form -->
                <form id="fabCategoryForm" class="fab-form" style="display: none;">
                    <div class="form-group">
                        <label for="fabCategoryType">Type</label>
                        <select id="fabCategoryType" required>
                            <option value="">Select type</option>
                            <option value="main">Main Category</option>
                            <option value="sub">Subcategory</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fabCategoryName">Name</label>
                        <input type="text" id="fabCategoryName" placeholder="e.g., Food, Transport" required>
                    </div>
                    <div class="form-group hidden" id="fabParentCategoryGroup">
                        <label for="fabParentCategory">Parent Category</label>
                        <select id="fabParentCategory">
                            <option value="">Select parent</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">
                        <i class="fas fa-plus"></i> Add Category
                    </button>
                </form>
            </div>
        </div>
    </div>  

    <!-- Edit Wallet Modal -->
    <div class="modal-overlay" id="editWalletModal">
        <div class="modal">
            <div class="modal-header" style="background: linear-gradient(135deg, #3B82F6 0%, #60A5FA 100%); position: relative; overflow: hidden;">
                <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%; animation: float 3s ease-in-out infinite;"></div>
                <button class="modal-close" onclick="document.getElementById('editWalletModal').classList.remove('active')">
                    <i class="fas fa-times"></i>
                </button>
                <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 8px;">
                    <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <i class="fas fa-wallet" style="font-size: 1.3rem; color: white;"></i>
                    </div>
                    <h2 class="modal-title" style="margin: 0; color: white;">Edit Wallet</h2>
                </div>
                <p class="modal-subtitle">Update wallet details</p>
            </div>
            <div class="modal-body" style="padding: 1.25rem;">
                <form id="editWalletForm">
                    <input type="hidden" id="editWalletId">
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="editWalletName" style="font-size: 0.85rem; margin-bottom: 0.3rem;">Wallet Name</label>
                        <input type="text" id="editWalletName" placeholder="e.g., Cash, Bank Account" required style="padding: 10px 12px; font-size: 0.95rem;">
                    </div>
                    
                    <div class="form-row" style="gap: 0.8rem; margin-top: 1rem;">
                        <button type="button" class="btn btn-outline" onclick="document.getElementById('editWalletModal').classList.remove('active')" style="padding: 10px; font-size: 0.9rem; flex: 1;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" style="padding: 10px; font-size: 0.9rem; flex: 1;">
                            <i class="fas fa-save"></i> Save
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div class="modal-overlay" id="editCategoryModal">
        <div class="modal">
            <div class="modal-header" style="background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%); position: relative; overflow: hidden;">
                <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%; animation: float 3s ease-in-out infinite;"></div>
                <button class="modal-close" onclick="document.getElementById('editCategoryModal').classList.remove('active')">
                    <i class="fas fa-times"></i>
                </button>
                <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 8px;">
                    <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <i class="fas fa-tags" style="font-size: 1.3rem; color: white;"></i>
                    </div>
                    <h2 class="modal-title" style="margin: 0; color: white;">Edit Category</h2>
                </div>
                <p class="modal-subtitle">Update category details</p>
            </div>
            <div class="modal-body" style="padding: 1.25rem;">
                <form id="editCategoryForm">
                    <input type="hidden" id="editCategoryId">
                    
                    <div class="form-group" style="margin-bottom: 0.8rem;">
                        <label for="editCategoryType" style="font-size: 0.85rem; margin-bottom: 0.3rem;">Type</label>
                        <select id="editCategoryType" required style="padding: 10px 12px; font-size: 0.95rem;">
                            <option value="">Select type</option>
                            <option value="main">Main Category</option>
                            <option value="sub">Subcategory</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0.8rem;">
                        <label for="editCategoryName" style="font-size: 0.85rem; margin-bottom: 0.3rem;">Name</label>
                        <input type="text" id="editCategoryName" placeholder="e.g., Food, Transport" required style="padding: 10px 12px; font-size: 0.95rem;">
                    </div>
                    
                    <div class="form-group hidden" id="editParentCategoryGroup" style="margin-bottom: 1rem;">
                        <label for="editParentCategory" style="font-size: 0.85rem; margin-bottom: 0.3rem;">Parent Category</label>
                        <select id="editParentCategory" style="padding: 10px 12px; font-size: 0.95rem;">
                            <option value="">Select parent</option>
                        </select>
                    </div>
                    
                    <div class="form-row" style="gap: 0.8rem; margin-top: 1rem;">
                        <button type="button" class="btn btn-outline" onclick="document.getElementById('editCategoryModal').classList.remove('active')" style="padding: 10px; font-size: 0.9rem; flex: 1;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" style="padding: 10px; font-size: 0.9rem; flex: 1;">
                            <i class="fas fa-save"></i> Save
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>  
    
    <div class="modal-overlay" id="budgetModal">
        <div class="modal">
            <div class="modal-header" style="background: linear-gradient(135deg, #8B5CF6 0%, #A78BFA 100%);">
                <button class="modal-close" id="closeBudgetModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Set Category Budget</h2>
                <p class="modal-subtitle">Monthly spending limit</p>
            </div>
            <div class="modal-body">
                <form id="budgetForm">
                    <input type="hidden" id="budgetId">
                    
                    <div class="form-group">
                        <label for="budgetCategory">Category</label>
                        <select id="budgetCategory" required>
                            <option value="">Select category</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="budgetAmount">Monthly Limit</label>
                        <div class="currency-input">
                            <span class="currency-symbol">Rp</span>
                            <input type="text" id="budgetAmount" placeholder="0" required>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn btn-outline" onclick="document.getElementById('budgetModal').classList.remove('active')" style="flex: 1;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            <i class="fas fa-save"></i> Save Budget
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>    

    <div class="modal-overlay" id="budgetWarningModal">
        <div class="modal">
            <div class="modal-header" style="background: linear-gradient(135deg, #F59E0B 0%, #EF4444 100%); position: relative; overflow: hidden;">
                <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%; animation: float 3s ease-in-out infinite;"></div>
                <button class="modal-close" id="closeBudgetWarning">
                    <i class="fas fa-times"></i>
                </button>
                <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 8px;">
                    <div style="width: 56px; height: 56px; background: rgba(255,255,255,0.25); border-radius: 16px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); box-shadow: 0 4px 16px rgba(0,0,0,0.15);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 1.8rem; color: white;"></i>
                    </div>
                </div>
                <h2 class="modal-title" style="margin: 0; color: white; font-size: 1.5rem;">Budget Exceeded!</h2>
                <p class="modal-subtitle" style="margin-top: 8px;">This expense will go over your spending limit</p>
            </div>
            
            <div class="modal-body" style="padding: 1.5rem;">
                <!-- Category Name -->
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="display: inline-block; background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); padding: 8px 16px; border-radius: 20px; border: 2px solid #F59E0B;">
                        <i class="fas fa-tag" style="color: #D97706; margin-right: 6px;"></i>
                        <span id="budgetWarningCategory" style="font-weight: 700; color: #92400E; font-size: 1rem;"></span>
                    </div>
                </div>
                
                <!-- Budget Details -->
                <div style="background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border-radius: 16px; padding: 1.25rem; margin-bottom: 1.5rem; border: 2px solid #F59E0B;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="color: #78350F; font-weight: 600; font-size: 0.9rem;">
                            <i class="fas fa-chart-line" style="margin-right: 6px;"></i>Budget Limit
                        </span>
                        <span id="budgetWarningBudget" style="font-weight: 700; color: #92400E; font-size: 1rem;"></span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="color: #78350F; font-weight: 600; font-size: 0.9rem;">
                            <i class="fas fa-minus-circle" style="margin-right: 6px;"></i>Already Spent
                        </span>
                        <span id="budgetWarningSpent" style="font-weight: 700; color: #D97706; font-size: 1rem;"></span>
                    </div>
                    
                    <div style="height: 1px; background: #F59E0B; margin: 12px 0; opacity: 0.3;"></div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="color: #78350F; font-weight: 600; font-size: 0.9rem;">
                            <i class="fas fa-plus-circle" style="margin-right: 6px;"></i>This Expense
                        </span>
                        <span id="budgetWarningNew" style="font-weight: 700; color: #DC2626; font-size: 1rem;"></span>
                    </div>
                    
                    <div style="height: 2px; background: linear-gradient(90deg, #F59E0B 0%, #EF4444 100%); margin: 12px 0;"></div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #78350F; font-weight: 700; font-size: 1rem;">
                            <i class="fas fa-equals" style="margin-right: 6px;"></i>Total After
                        </span>
                        <span id="budgetWarningTotal" style="font-weight: 800; color: #DC2626; font-size: 1.2rem;"></span>
                    </div>
                </div>
                
                <!-- Warning Message -->
                <div style="background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%); border-left: 4px solid #EF4444; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <i class="fas fa-info-circle" style="color: #DC2626; margin-top: 2px; font-size: 1.1rem;"></i>
                        <div>
                            <p style="margin: 0; color: #7F1D1D; font-weight: 600; font-size: 0.95rem; line-height: 1.5;">
                                You'll be <span id="budgetWarningOver" style="font-weight: 800; color: #DC2626;"></span> over budget for this month.
                            </p>
                            <p style="margin: 6px 0 0 0; color: #991B1B; font-size: 0.85rem; line-height: 1.4;">
                                ðŸ’¡ <strong>Tip:</strong> Check the "ðŸ’° Reimbursable" box if this expense will be reimbursed!
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 12px; margin-top: 1.5rem;">
                    <button class="btn btn-outline" id="cancelBudgetWarning" style="flex: 1; padding: 14px; font-size: 0.95rem;">
                        <i class="fas fa-times-circle"></i>
                        <span>Cancel</span>
                    </button>
                    <button class="btn" id="confirmBudgetWarning" style="flex: 1; padding: 14px; font-size: 0.95rem; background: linear-gradient(135deg, #F59E0B 0%, #EF4444 100%); color: white;">
                        <i class="fas fa-check-circle"></i>
                        <span>Add Anyway</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="expenseSelectorModal">
        <div class="modal">
            <div class="modal-header" style="background: linear-gradient(135deg, #8B5CF6 0%, #A78BFA 100%);">
                <button class="modal-close" id="closeExpenseSelectorModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Select Expenses to Reimburse</h2>
                <p class="modal-subtitle">Choose which expenses this income covers</p>
            </div>
            <div class="modal-body">
                <!-- Expense selector list -->
                <div class="expense-selector-list" id="expenseSelectorList">
                    <!-- Will be populated dynamically -->
                </div>
                
                <!-- Summary -->
                <div class="expense-selector-summary" id="expenseSelectorSummary" style="display: none;">
                    <div class="summary-row">
                        <span class="summary-label">Selected Expenses:</span>
                        <span class="summary-value" id="selectedExpenseCount">0</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Total Amount:</span>
                        <span class="summary-value" id="selectedExpenseTotal">Rp 0</span>
                    </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; gap: 10px; margin-top: 1rem;">
                    <button class="btn btn-outline" id="cancelExpenseSelector" style="flex: 1;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="btn btn-primary" id="confirmExpenseSelector" style="flex: 1;">
                        <i class="fas fa-check"></i> Link Selected
                    </button>
                </div>
            </div>
        </div>
    </div>    

    <!-- Reimbursement Details Modal -->
    <div class="modal-overlay" id="reimbursementDetailsModal">
        <div class="modal">
            <div class="modal-header" style="background: linear-gradient(135deg, #10B981 0%, #34D399 100%);">
                <button class="modal-close" id="closeReimbursementDetails">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Reimbursement Details</h2>
                <p class="modal-subtitle">Payment information</p>
            </div>
            <div class="modal-body">
                <div id="reimbursementDetailsContent">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Unlink Reimbursement Confirmation Modal -->
    <div class="modal-overlay" id="unlinkReimbursementModal">
        <div class="modal">
            <div class="modal-header" style="background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);">
                <button class="modal-close" id="closeUnlinkReimbursement">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Unlink Reimbursement?</h2>
                <p class="modal-subtitle">This will return expenses to pending</p>
            </div>
            <div class="modal-body">
                <p id="unlinkReimbursementMessage" style="margin-bottom: 1.5rem; font-size: 0.95rem;">
                    Are you sure you want to unlink this reimbursement? The linked expenses will return to pending status.
                </p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline" id="cancelUnlinkReimbursement" style="flex: 1;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="btn" id="confirmUnlinkReimbursement" style="flex: 1; background: #EF4444; color: white;">
                        <i class="fas fa-unlink"></i> Unlink
                    </button>
                </div>
            </div>
        </div>
    </div>    

    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <div class="modal-header" style="background: linear-gradient(135deg, #10B981 0%, #34D399 100%);">
                <button class="modal-close" id="closeExportModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">
                    <i class="fas fa-download"></i> Export Data
                </h2>
                <p class="modal-subtitle">Download your financial data</p>
            </div>
            <div class="modal-body">
                <form id="exportForm">
                    <!-- Export Type -->
                    <div class="form-group">
                        <label for="exportType">What to export</label>
                        <select id="exportType" required>
                            <option value="all">All Transactions</option>
                            <option value="expenses">Expenses Only</option>
                            <option value="income">Income Only</option>
                            <option value="summary">Summary Report</option>
                            <option value="budgets">Budgets</option>
                        </select>
                    </div>

                    <!-- Date Range -->
                    <div class="form-group" id="dateRangeGroup">
                        <label for="exportDateRange">Time period</label>
                        <select id="exportDateRange" required>
                            <option value="this-month">This Month</option>
                            <option value="last-month">Last Month</option>
                            <option value="last-3-months">Last 3 Months</option>
                            <option value="last-6-months">Last 6 Months</option>
                            <option value="this-year">This Year</option>
                            <option value="last-year">Last Year</option>
                            <option value="all-time">All Time</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>

                    <!-- Custom Date Range -->
                    <div id="customDateRangeGroup" style="display: none;">
                        <div class="form-row" style="gap: 0.8rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="exportStartDate">From</label>
                                <input type="date" id="exportStartDate">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="exportEndDate">To</label>
                                <input type="date" id="exportEndDate">
                            </div>
                        </div>
                    </div>

                    <!-- Format (future-proof for PDF/Excel) -->
                    <div class="form-group">
                        <label for="exportFormat">Format</label>
                        <select id="exportFormat" required>
                            <option value="csv">CSV (Excel, Sheets)</option>
                        </select>
                    </div>

                    <!-- Export Button -->
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px; margin-top: 1rem;">
                        <i class="fas fa-download"></i> Download
                    </button>
                </form>

                <!-- Export Info -->
                <div style="margin-top: 1rem; padding: 1rem; background: var(--light-gray); border-radius: 8px; font-size: 0.85rem; color: var(--gray);">
                    <i class="fas fa-info-circle"></i> 
                    CSV files open in Excel, Google Sheets, and Numbers. Your data stays privateâ€”everything is processed in your browser.
                </div>
            </div>
        </div>
    </div>    

    <!-- Receipt Viewer Modal -->
    <div class="modal-overlay" id="receiptViewerModal">
        <div class="modal" style="max-width: 90vw; max-height: 90vh;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);">
                <button class="modal-close" id="closeReceiptViewer">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Receipt</h2>
                <p class="modal-subtitle" id="receiptExpenseName">Expense details</p>
            </div>
            <div class="modal-body" style="padding: 0; overflow: auto; max-height: calc(90vh - 100px);">
                <div id="receiptViewerContent" style="display: flex; align-items: center; justify-content: center; min-height: 400px;">
                    <!-- Receipt content will be loaded here -->
                </div>
            </div>
            <div style="padding: 1rem; border-top: 1px solid var(--light-gray); display: flex; gap: 10px; justify-content: flex-end;">
                <a id="receiptDownloadBtn" href="#" download class="btn btn-outline" target="_blank">
                    <i class="fas fa-download"></i> Download
                </a>
                <button class="btn btn-primary" onclick="document.getElementById('receiptViewerModal').classList.remove('active')">
                    <i class="fas fa-check"></i> Close
                </button>
            </div>
        </div>
    </div>    

    <script type="module">

        async function initApp() {
            try {
                const response = await fetch('/api/config');
                if (!response.ok) {
                    throw new Error('Failed to fetch config');
                }
                
                const config = await response.json();

                // Create Supabase client AFTER config is loaded
                const supabase = window.supabase.createClient(
                    config.supabaseUrl,
                    config.supabaseAnonKey
                    // SUPABASE_URL, 
                    // SUPABASE_ANON_KEY                    
                );
                
                console.log('Supabase client created');
                
                // Import and initialize the app
                const { createApp } = await import('./js/app.js');
                
                console.log('Starting FinTrack application...');
                
                // Create and initialize the app
                const app = createApp(supabase);
                await app.init();
                
                // Make available globally for debugging
                window.finTrack = {
                    app,
                    ui: app.ui,
                    state: app.state,
                    auth: app.auth,
                    db: app.db
                };
                
                // Store pending delete reference
                window.finTrack.pendingDelete = null;

                // DEBUG: Add console access
                console.log('FinTrack App initialized:', window.finTrack);

                // DEBUG: Test state access
                window.finTrack.debug = {
                    getState: () => window.finTrack.state.getState(),
                    getExpenses: () => window.finTrack.state.getExpenses(),
                    getIncomes: () => window.finTrack.state.getIncomes(),
                    getWallets: () => window.finTrack.state.getWallets(),
                    getCategories: () => window.finTrack.state.getCategories()
                };                
                
                console.log('Application started successfully');
            } catch (error) {
                console.error('Failed to start application:', error);
                
                // Show error to user
                const alertContainer = document.getElementById('alertContainer');
                if (alertContainer) {
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-error';
                    alert.innerHTML = `<i class="fas fa-exclamation-circle"></i> Failed to load application. Please refresh. Error: ${error.message}`;
                    alertContainer.appendChild(alert);
                }
            }
        }

        // Start when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // Global event listeners that need to be in the HTML file
        document.addEventListener('DOMContentLoaded', function() {
            // Close modals when clicking outside
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-overlay')) {
                    e.target.classList.remove('active');
                }
            });
            
            // Close modals with escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                        modal.classList.remove('active');
                    });
                }
            });
            
            // Make edit functions globally available
            window.editExpense = function(id) {
                if (window.finTrack && window.finTrack.ui) {
                    window.finTrack.ui.editExpense(id);
                }
            };
            
            window.editIncome = function(id) {
                if (window.finTrack && window.finTrack.ui) {
                    window.finTrack.ui.editIncome(id);
                }
            };
            
            window.editWallet = function(id) {
                if (window.finTrack && window.finTrack.ui) {
                    window.finTrack.ui.editWallet(id);
                }
            };
            
            window.editCategory = function(id) {
                if (window.finTrack && window.finTrack.ui) {
                    window.finTrack.ui.editCategory(id);
                }
            };
            
            // v5.2
            window.openBudgetModal = function() {
                if (window.finTrack && window.finTrack.ui) {
                    window.finTrack.ui.openBudgetModal();
                }
            };

            window.toggleRecentActivity = function() {
                const container = document.getElementById('recentActivityContainer');
                const chevron = document.getElementById('recentActivityChevron');
                
                if (container.style.display === 'none') {
                    container.style.display = 'block';
                    chevron.style.transform = 'rotate(180deg)';
                } else {
                    container.style.display = 'none';
                    chevron.style.transform = 'rotate(0deg)';
                }
            };
            
            document.getElementById('closeReimbursementDetails')?.addEventListener('click', () => {
                document.getElementById('reimbursementDetailsModal').classList.remove('active');
            });

            // Unlink Reimbursement Modal
            document.getElementById('closeUnlinkReimbursement')?.addEventListener('click', () => {
                document.getElementById('unlinkReimbursementModal').classList.remove('active');
                window.finTrack.pendingUnlinkIncomeId = null;
            });

            document.getElementById('cancelUnlinkReimbursement')?.addEventListener('click', () => {
                document.getElementById('unlinkReimbursementModal').classList.remove('active');
                window.finTrack.pendingUnlinkIncomeId = null;
            });

            document.getElementById('confirmUnlinkReimbursement')?.addEventListener('click', () => {
                if (window.finTrack && window.finTrack.app) {
                    window.finTrack.app.confirmUnlinkReimbursement();
                }
            });            

        });  

        window.toggleSettingsSection = function(section) {
            const body = document.getElementById(`${section}Body`);
            const chevron = document.getElementById(`${section}Chevron`);
            
            if (!body || !chevron) return;
            
            const isExpanded = body.style.display === 'block';
            
            if (isExpanded) {
                body.style.display = 'none';
                chevron.style.transform = 'rotate(0deg)';
            } else {
                body.style.display = 'block';
                chevron.style.transform = 'rotate(180deg)';
            }
        };        
    </script>

</body>

</html>
